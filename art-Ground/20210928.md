### **어떤 에러인가요?**

- cookie 옵션 설정 miss로 인한 브라우저 토큰 저장 및 삭제 에러

### **에러 메시지**

- 추정 에러 원인:
  맨 처음 로그인 테스트 시에 로컬 서버에서 보낸 만료기간 없는 토큰을 보낸 후 브라우저에 저장됨, 그 이후 쿠키 삭제가 제대로 되지 않은 상태에서
  배포 서버에서 계속 토큰을 담은 쿠키를 보냈기 때문에 배포 서버에서 보낸 쿠키가 브라우저에 저장되지 않음 + 도메인 설정을 처음부터 해주지 않아서 로컬 서버로 도메인 설정이 되어 버렸고, 배포 서버에서 보낸 토큰은 cross-site라는 이유로 브라우저에서 block함.
  clearCookie 옵션에도 [sameSite: none, secure: true] 설정을 해주지 않고 계속 쿠키 삭제 요청을 보내서 마찬가지로 cross-site라는 이유로 브라우저에서 삭제해주지 않음(우리 서버가 보낸 205 코드는 쿠키를 삭제해주고 응답을 돌려주었지만 브라우저에서 이를 이행하지 않음). 크롬 쿠키 정책이 sameSite 옵션을 따로 지정해주지 않으면 defaults로 lax 정책으로 설정되는데, 이 설정 때문에 최초로 로컬 서버에서 보낸 쿠키가 삭제되지 않았고, 이후 새로 발급해서 보낸 쿠키도 삭제가 되지 않았음.

### **에러 핸들링 방법**

- 최초에 발행되어 브라우저에 저장된 쿠키를 크롬 설정에서 임의로 삭제(크롬 설정 > 인터넷 기록 삭제 > 쿠키 삭제) 먼저 해줌.
- 이후 쿠키를 보낼 때(res.cookie)와 삭제할 때(res.clearCookie)의 옵션을 맞춰주고(sameSite: none, secure: true), 도메인도 혹시나 해서 맞춰줌.
- 쿠키가 삭제되지 않는 에러를 방지하기 위해 쿠키의 maxAge 옵션을 하루로 설정해주고 토큰 유효기간도 설정함.

* first project에서는 http 프로토콜을 사용했기 때문에 쿠키를 사용할 수 없어서 로컬 스토리지에 토큰을 저장하는 방식을 사용했기 때문에 로그아웃 시에 클라이언트에서 로컬 스토리지에 토큰만 삭제해주면 되었다. 그래서 토큰 유효기간이 필요가 없었는데 이번에는 https 프로토콜을 사용하게 되면서 쿠키에 토큰을 저장하게 되었기 때문에 설정해주지 않으면 큰일난다는 것을 배웠다.

### **에러 핸들링을 위해 참고한 레퍼런스 링크**

프로토콜을 사용하게 되면서 쿠키에 토큰을 저장하게 되었기 때문에
https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie
https://ifuwanna.tistory.com/223
https://www.inflearn.com/questions/18004
https://expressjs.com/ko/api.html
https://www.hahwul.com/2020/01/18/samesite-lax/
